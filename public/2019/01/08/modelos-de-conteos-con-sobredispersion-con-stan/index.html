<!DOCTYPE html>
<html class="no-js" lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Modelos de conteos con sobredispersión (con Stan) - datanalytics</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Modelos de conteos con sobredispersión (con Stan)" />
<meta property="og:description" content="Esta entrada muestra cómo afrontar (con Stan) un problema que encontré el otro día en un lugar que no puedo mencionar pero en el que sé que me leen (y los destinatarios sabrán que va por ellos).
El contexto es el siguiente: se hace un test A/B donde la variable de interés son unos conteos. Hay varios grupos (aquí los reduciré a dos) y los datos siguen aproximadamente (aquí omitiré la parte de la inflación de ceros) una distribución de Poisson." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2019/01/08/modelos-de-conteos-con-sobredispersion-con-stan/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-01-08T08:13:00&#43;00:00" />
<meta property="article:modified_time" content="2019-01-08T08:13:00&#43;00:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alegreya:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="datanalytics" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">datanalytics</div>
					<div class="logo__tagline">Estadística y análisis de datos</div>
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Modelos de conteos con sobredispersión (con Stan)</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2019-01-08T08:13:00Z">2019-1-8</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/r/" rel="category">r</a>
	</span>
</div></div>
		</header>
		<div class="content post__content clearfix">
			<p>Esta entrada muestra cómo afrontar (con Stan) un problema que encontré el otro día en un lugar que no puedo mencionar pero en el que sé que me leen (y los destinatarios sabrán que va por ellos).</p>
<p>El contexto es el siguiente: se hace un test A/B donde la variable de interés son unos conteos. Hay varios grupos (aquí los reduciré a dos) y los datos siguen <em>aproximadamente</em> (aquí omitiré la parte de la inflación de ceros) una distribución de Poisson. Pero solo <em>aproximadamente</em>: existe sobredispersión, es decir, la varianza de los datos excede su media.</p>
<p>Así que la formulación más natural, en la que cada $latex n_i \sim \text{Pois}(\lambda)$ no vale. Recurrir a la binomial negativa es una opción, la opción de libro viejo, pero destruye la interpretabilidad del modelo y obliga a renunciar a las propiedades más interesantes de la Poisson (p.e., la aditividad).</p>
<p>Una mejor aproximación es interpretar la sobredispersión de la Poisson como efecto de la heterogeneidad de los sujetos. Es decir, que cada sujeto tiene su propia $latex \lambda$ y crear un modelo jerárquico: uno para las lambdas (p.e., $latex \lambda_i \sim \Gamma(a, b)$ y otro para los conteos, $latex n_i \sim \text{Pois}(\lambda_i)$.</p>
<p>Para lo cual, genero datos (obviamente, de acuerdo con mi modelo):</p>
<pre><code># sujetos por experimento
n &lt;- 5000

# mejora en tratamiento
incr &lt;- .05

# parámetros iniciales de la
# distribución de heterogeneidad
a &lt;- 3
b &lt;- 4


prop.control &lt;- rgamma(n, a, b)
obs.control &lt;- sapply(prop.control,
                      function(lambda) rpois(1, lambda))

prop.tratamiento &lt;- rgamma(n, a, b) * (1 + incr)
obs.tratamiento &lt;- sapply(prop.tratamiento,
                          function(lambda) rpois(1, lambda))
</code></pre>
<p>Y ahora modelo en Stan:</p>
<pre><code>&lt;code&gt;data {
  int n;
  int control[n];
  int tratamiento[n];
}

parameters {
  real&lt;lower = 0&gt; a;
  real&lt;lower = 0&gt; b;
  real&lt;lower = -0.01, upper = 0.2&gt; incr;
  real&lt;lower = 0&gt; lambdas_control[n];
  real&lt;lower = 0&gt; lambdas_tratamiento[n];
}

model {
  lambdas_control ~ gamma(a, b);
  lambdas_tratamiento ~ gamma(a, b);

  for(i in 1:n){
    control[i] ~ poisson(lambdas_control[i]);
    tratamiento[i] ~ poisson(lambdas_tratamiento[i] * (1 + incr));
  }
}&lt;/code&gt;
</code></pre>
<p>Y ejecuto:</p>
<pre><code>&lt;code&gt;library(rstan)

fit &lt;- stan(&quot;disp_poisson.stan&quot;,
            data = list(n = n, control = obs.control,
                   tratamiento = obs.tratamiento),
            iter = 10000, warmup = 2000,
            chains = 1, thin = 10)

res &lt;- as.data.frame(fit)&lt;/code&gt;
</code></pre>
<p>El resultado es lo de menos. Lo de más, que tenemos disponible este procedimiento para modelar la sobre dispersión de los conteos, que es más natural que otros.</p>
<p><strong>Nota:</strong> para una visión alternativa, <a href="https://journals.sagepub.com/doi/abs/10.1177/1471082X14524676?rss=1">esto</a>.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/ceros/" rel="tag">ceros</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/inflaci%C3%B3n/" rel="tag">inflación</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/poisson/" rel="tag">poisson</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/stan/" rel="tag">stan</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/sobredispersi%C3%B3n/" rel="tag">sobredispersión</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/2019/01/07/dhondt-vs-lm/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Anterior</span>
			<p class="pager__title">d’Hondt vs lm</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/2019/01/09/cadenas-de-markov-para-generar-trayectorias-posibles-de-huracanes/" rel="next">
			<span class="pager__subtitle">Siguiente&thinsp;»</span>
			<p class="pager__title">Cadenas de Markov para generar trayectorias posibles de huracanes</p>
		</a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-recent widget">
	<h4 class="widget__title">Más Recientes</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2021/12/09/mas-sobre-exceso-mortalidad-noviembre-2021/">Sobre el exceso de mortalidad en noviembre de 2021</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/09/mas-sobre-la-estimacion-de-probabilidades-de-eventos-que-no-se-repiten/">Más sobre la estimación de probabilidades de eventos que no se repiten</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/07/estadistica-vs-siquiatria-la-aparente-contradiccion-la-profunda-sintesis/">Estadística vs siquiatría: la aparente contradicción, la profunda síntesis</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/02/por-que-cabe-argumentar-que-estos-resultados-infraestiman-la-efectividad-de-las-vacunas-contra-el-covid/">¿Por qué cabe argumentar que estos resultados infraestiman la efectividad de las vacunas contra el covid?</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/11/25/un-episodio-relevante-para-estas-paginas-extraido-de-un-espia-perfecto/">Un episodio relevante para estas páginas extraído de &#34;Un espía perfecto&#34;</a></li>
		</ul>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 datanalytics.
      
		</div>
	</div>
</footer>

	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"], ["$latex", "$"],["\\(","\\)"]]} })
</script>

</body>
</html>