<!DOCTYPE html>
<html class="no-js" lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Kriging con Stan - datanalytics</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kriging con Stan" />
<meta property="og:description" content="Este mes de julio, cuórum mediante, impartiré en la UPC un curso que he maltitulado, mor de brevedad, Estadística Bayesiana Aplicada.
Los cursos de estadística bayesiana son teoría, mucha teoría, y unos ejemplos tontos que quieren justificarla. Del tipo: hagamos lo que ya sabemos hacer de otra manera más; busquemos una alternativa molona al p-valor (y usémosla como usar íamos un p-valor, por supuesto), etc.
Mi curso debería haberse titulado algo así como: Problemas reales (aunque simplificados por motivos estrictamente pedagógicos) resueltos con tecnología bayesiana porque, si no, dígame Vd." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2018/03/01/kriging-con-stan/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-03-01T08:13:08&#43;00:00" />
<meta property="article:modified_time" content="2018-03-01T08:13:08&#43;00:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alegreya:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="datanalytics" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">datanalytics</div>
					<div class="logo__tagline">Estadística y análisis de datos</div>
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kriging con Stan</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2018-03-01T08:13:08Z">2018-3-1</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/estad%C3%ADstica/" rel="category">estadística</a>
	</span>
</div></div>
		</header>
		<div class="content post__content clearfix">
			<p>Este mes de julio, cuórum mediante, impartiré en la UPC un curso que he maltitulado, mor de brevedad, <em>Estadística Bayesiana Aplicada</em>.</p>
<p>Los cursos de estadística bayesiana son teoría, mucha teoría, y unos ejemplos tontos que quieren justificarla. Del tipo: hagamos lo que ya sabemos hacer de otra manera más; busquemos una alternativa molona al p-valor (y usémosla como usar
íamos un p-valor, por supuesto), etc.</p>
<p>Mi curso debería haberse titulado algo así como: <em>Problemas reales (aunque simplificados por motivos estrictamente pedagógicos) resueltos con tecnología bayesiana porque, si no, dígame Vd. cómo lo haría: ¿con optim? Jajajajaja&hellip;</em></p>
<p>Es un curso en el que aplicaciones reales justifican la tecnología y esta, a su vez, la teoría. Y sí, enlazará con teoría de la decisión propiamente formulada, remitirá (a lo más) a libracos, y enseñará a resolver los problemas con Stan.</p>
<p>Uno de los problemas avanzados pero a la mano que quiero plantear es el del <em>kriging</em>. Por simplificar, en una dimensión. Hay muchas cosas de contar eso del <em>kriging</em>, muchas de las cuales no he entendido jamás, pero la más
sencilla es generalizando los modelos lineales generalizados. Por simplificar, desgeneralicemos los GLMs y partamos del modelo lineal,</p>
<p>$latex Y_i | X_i ,, \sim ,, N(\mu_i, \sigma)$</p>
<p>o bien,</p>
<p>$latex y_i = \mu(x_i) + \epsilon$</p>
<p>donde $latex \epsilon$ se ajusta a la especificaión previa. Si conocemos $latex \mu$, podremos hacer predicciones para nuevos valores $latex x$.</p>
<p>Aquí las observaciones son independientes. Pero en nuestro problema observamos medidas en determinados puntos (en un terreno (2D), en una línea (1D), etc.) y <em>sabemos</em> que existe cierta regularidad: los puntos próximos están correlacionados entre sí.</p>
<p>El objetivo del <em>kriging</em> es poder realizar estimaciones en puntos no observados utilizando no solo nuestro conocimiento de $latex \mu$, sino también aquello que nos aporten los puntos $latex x$ conocidos próximos al que nos interesa.</p>
<p>Por concretar, dados los valores</p>
<p><img src="https://www.datanalytics.com/wp-uploads/2018/02/sinusoide_ruido.png" alt=""></p>
<p>podríamos querer obtener estimaciones de la función subyacente en alguno intermedio. O en una rejilla determinada. Sí, como si usásemos <em>loess</em> o similar. Pero, en nuestro caso, usando el siguiente modelo:</p>
<p>$latex Y | X ,, \sim ,, N(\mu, \Sigma)$</p>
<p>donde $latex \mu$ es un vector de medias y $latex \Sigma$ es una matriz de covarianzas en la que $latex \Sigma_{ij}$ es una función decreciente de la distancia entre $latex x_i$ y $latex x_j$.</p>
<p>Al modelo básico se le pueden añadir cascabeles variados:</p>
<ul>
<li>Sumarle a $latex \Sigma$ una matriz diagonal que recoja el error de medición.</li>
<li>Variables independientes y sus coeficientes en la determinación de la media $latex \mu$.</li>
<li>Funciones de enlace para que $Y$ sea no el valor deseado sino $latex \log(\lambda)$ en un modelo de Poisson o la <!-- raw HTML omitted -->invlogis<!-- raw HTML omitted --> de una probabilidad.</li>
</ul>
<p>En nuestro caso, se puede estimar la función subyacente en una rejilla,</p>
<p><img src="https://www.datanalytics.com/wp-uploads/2018/02/kriging_sinuoide.png" alt=""></p>
<p>con el código</p>
<pre><code>    library(rstan)
    library(reshape2)
    library(ggplot2)
    library(plyr)

    n_sample &lt;- 30
    n_grid   &lt;- 100
    sd_error &lt;- 0.1

    x &lt;- sort(runif(n_sample) * 2 * pi)
    y &lt;- sin(x) + rnorm(n_sample, 0, sd_error)

    rejilla &lt;- seq(0, 2 * pi, length.out = n_grid)

    all_x &lt;- c(x, rejilla)

    distances &lt;- as.matrix(dist(as.matrix(all_x), method = &quot;manhattan&quot;))
    distances &lt;- distances^1.5

    stan_data &lt;- list(
    N1 = n_sample,
    N2 = n_grid,
    N  = n_sample + n_grid,
    x  = all_x,
    y0 = y,
    dists = distances
    )

    fit_alt &lt;- stan(file = &quot;krigging_1D.stan&quot;,
                data = stan_data,
                iter = 10000, warmup = 5000,
                chains = 1, thin = 10)

    res &lt;- as.data.frame(fit_alt)

    preds &lt;- res[, grep(&quot;^y2&quot;, colnames(res))]
    preds$id &lt;- 1:nrow(preds)
    preds &lt;- melt(preds, id.vars = &quot;id&quot;)
    preds$x &lt;- gsub(&quot;y2\\[(.*)\\]&quot;, &quot;\\1&quot;, preds$variable)
    preds$x &lt;- as.numeric(preds$x)

    preds$x &lt;- rejilla[preds$x]

    ggplot(preds, aes(x = x, y = value)) + geom_point(alpha = 0.1)

    tmp &lt;- ddply(preds, .(x), summarize, y = median(value))

    plot(x, y, main = &quot;Kriging fit to noise curve observations&quot;,
        xlab = &quot;&quot;, ylab = &quot;&quot;)
    lines(tmp$x, tmp$y, type = &quot;l&quot;, col = &quot;red&quot;)
</code></pre>
<p>que tira de</p>
<pre><code>    data {
    int&lt;lower=1&gt; N1; // number of data points
    int&lt;lower=1&gt; N2; // number of grid points
    int&lt;lower=1&gt; N;  // N1 + N2
    real x[N];       // number of outcomes
    real y0[N1];     // observed values
    matrix[N, N] dists;    // distances between points
    }

    parameters {
    vector[N2] y2;   // predictions for missing values (grid)
    real &lt;lower = 0&gt; sigma;
    real &lt;lower = 0&gt; phi;
    real &lt;lower = 0&gt; sd_noise;
    real mu;
    }

    model {
    vector[N] y;
    vector[N] means;
    matrix[N,N] Sigma;
    matrix[N,N] L;

    // y values
    for(i in 1:N1) y[i]    = y0[i];
    for(i in 1:N2) y[N1+i] = y2[i];

    // means: equal to mu
    for(i in 1:N) means[i] = mu;

    // priors (non informative)
    sd_noise ~ normal(0, 1);
    sigma ~ normal(0, 1);
    phi   ~ normal(0, 3);
    mu    ~ normal(0, 1);
    y2    ~ normal(0, 1);

    // covariance matrix
    Sigma = sigma^2 * exp(-phi * dists);
    for(i in 1:N) Sigma[i,i] = Sigma[i,i] + sd_noise;


    // model
    L = cholesky_decompose(Sigma);
    y ~ multi_normal_cholesky(means, L);
    }
</code></pre>
<p>En el código anterior $latex \Sigma$ es una matriz que tiene valores $latex \sigma^2 + r^2$ en la diagonal ($latex r$ es la desviación estándar del ruido de observación) y $latex \sigma^2 \exp(-\phi d_{ij}^{1.5})$ fuera de ella.</p>
<p>Así que, en resumen, el <em>kriging</em> es conceptualmente sencillo y computacionalmente asequible. Y si te interesan estas y más cosas y a primeros de julio estás por Barcelona con tu portátil, planteáte aprender y practicar estas cosas por las mañanicas de una semana.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/curso/" rel="tag">curso</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/kriging/" rel="tag">kriging</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/rstan/" rel="tag">rstan</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/stan/" rel="tag">stan</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/upc/" rel="tag">upc</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/2018/02/28/documentar-como-el-culo-no-pensar-en-el-usuario-final-ser-incapaz-de-ponerte-en-su-situacion-etc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Anterior</span>
			<p class="pager__title">Documentar como el culo, no pensar en el usuario final, ser incapaz de ponerte en su situación, etc.</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/2018/03/02/reflexiones-bayesianas-al-hilo-del-manido-independientemente-de-su-ideologia-los-economistas-suelen-estar-de-acuerdo-en-que/" rel="next">
			<span class="pager__subtitle">Siguiente&thinsp;»</span>
			<p class="pager__title">Reflexiones bayesianas al hilo del manido: &#34;Independientemente de su ideología, los economistas suelen estar de acuerdo en que...&#34;</p>
		</a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-recent widget">
	<h4 class="widget__title">Más Recientes</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2021/12/09/mas-sobre-exceso-mortalidad-noviembre-2021/">Sobre el exceso de mortalidad en noviembre de 2021</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/09/mas-sobre-la-estimacion-de-probabilidades-de-eventos-que-no-se-repiten/">Más sobre la estimación de probabilidades de eventos que no se repiten</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/07/estadistica-vs-siquiatria-la-aparente-contradiccion-la-profunda-sintesis/">Estadística vs siquiatría: la aparente contradicción, la profunda síntesis</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/02/por-que-cabe-argumentar-que-estos-resultados-infraestiman-la-efectividad-de-las-vacunas-contra-el-covid/">¿Por qué cabe argumentar que estos resultados infraestiman la efectividad de las vacunas contra el covid?</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/11/25/un-episodio-relevante-para-estas-paginas-extraido-de-un-espia-perfecto/">Un episodio relevante para estas páginas extraído de &#34;Un espía perfecto&#34;</a></li>
		</ul>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 datanalytics.
      
		</div>
	</div>
</footer>

	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"], ["$latex", "$"],["\\(","\\)"]]} })
</script>

</body>
</html>