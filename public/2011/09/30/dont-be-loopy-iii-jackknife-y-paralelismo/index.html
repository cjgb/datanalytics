<!DOCTYPE html>
<html class="no-js" lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Dont be loopy! (III: jackknife y paralelismo) - datanalytics</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Dont be loopy! (III: jackknife y paralelismo)" />
<meta property="og:description" content="Esta es la tercera entrega de una serie de artículos en los que comparo SAS y R a la hora de realizar diversos tipos de simulaciones basados en Don&rsquo;t Be Loopy: Re-Sampling and Simulation the SAS® Way.
Esta vez toca compararlos a la hora de aplicar el método del jackknife.
Primero, el código SAS que recomienda el autor del artículo, que calcula la curtosis de un conjunto de datos trivial (una muestra de 10k valores que siguen una distribución uniforme):" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2011/09/30/dont-be-loopy-iii-jackknife-y-paralelismo/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2011-09-30T06:52:59&#43;00:00" />
<meta property="article:modified_time" content="2011-09-30T06:52:59&#43;00:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alegreya:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="datanalytics" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">datanalytics</div>
					<div class="logo__tagline">Estadística y análisis de datos</div>
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Dont be loopy! (III: jackknife y paralelismo)</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2011-09-30T06:52:59Z">2011-9-30</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/r/" rel="category">r</a>
	</span>
</div></div>
		</header>
		<div class="content post__content clearfix">
			<p>Esta es la tercera entrega de una serie de artículos en los que comparo SAS y R a la hora de realizar diversos tipos de simulaciones basados en <em><a href="http://www.pnwsug.org/sites/test.pnwsug.org/files/proceedings/David%20Cassell%20-%20Don't%20Be%20Loopy.pdf">Don&rsquo;t Be Loopy: Re-Sampling and Simulation the SAS® Way</a></em>.</p>
<p>Esta vez toca compararlos a la hora de aplicar el método del <em><a href="http://en.wikipedia.org/wiki/Resampling_(statistics)#Jackknife">jackknife</a></em>.</p>
<p>Primero, el código SAS que recomienda el autor del artículo, que calcula la curtosis de un conjunto de datos trivial (una muestra de 10k valores que siguen una distribución uniforme):</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sas" data-lang="sas"><span style="color:#66d9ef">data </span>test;
    <span style="color:#66d9ef">do</span> i = <span style="color:#ae81ff">1</span> to <span style="color:#ae81ff">10000</span>;
        <span style="color:#66d9ef">x</span> = ranuni(<span style="color:#ae81ff">1234</span>);
        <span style="color:#66d9ef">output</span>;
    <span style="color:#66d9ef">end</span>;
    <span style="color:#66d9ef">keep</span> <span style="color:#66d9ef">x</span><span style="color:#66d9ef">;
</span><span style="color:#66d9ef">run;</span>
<span style="color:#66d9ef">
</span><span style="color:#66d9ef">data </span>outb;
  <span style="color:#66d9ef">do</span> replicate = <span style="color:#ae81ff">1</span> to numrecs;
    <span style="color:#66d9ef">do</span> rec = <span style="color:#ae81ff">1</span> to numrecs;
      <span style="color:#66d9ef">set</span> test nobs=numrecs point=rec;
      <span style="color:#66d9ef">if</span> replicate ^= rec <span style="color:#66d9ef">then</span> <span style="color:#66d9ef">output</span>;
    <span style="color:#66d9ef">end</span>;
  <span style="color:#66d9ef">end</span>;
  <span style="color:#66d9ef">stop</span><span style="color:#66d9ef">;
</span><span style="color:#66d9ef">run;</span>

ods listing close<span style="color:#66d9ef">;
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">proc univariate </span>data=outb;
  var <span style="color:#66d9ef">x</span>;
  <span style="color:#66d9ef">by</span> replicate;
  <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">out</span>=outall kurtosis=curt<span style="color:#66d9ef">;
</span><span style="color:#66d9ef">run;</span>

ods listing<span style="color:#66d9ef">;
</span><span style="color:#66d9ef">
</span><span style="color:#66d9ef">proc univariate </span>data=outall;
  var curt;
  <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">out</span>=final mean=jmean std=jstd<span style="color:#66d9ef">;
</span><span style="color:#66d9ef">run;</span></code></pre></td></tr></table>
</div>
</div>
<p>Tarda en ejecutarse 110 segundos en mi máquina. He probado también a aplicar el procedimiento a conjuntos de datos con 50k muestras, pero el sistema no ha dado de sí: se ha quedado sin espacio en disco.</p>
<p>(Nota: véanse los <a href="http://www.datanalytics.com/blog/2011/09/23/don%E2%80%99t-be-loopy-ii/">comentarios a algunas de las entradas anteriores de la serie</a>. Algunos de los lectores de esta bitácora, de alguna manera, han logrado evitar el cuello de botella que para SAS supone depender del acceso a disco manteniendo un uso de CPU decente que yo, dicho sea de paso, no he visto casi nunca: una CPU al 100% en un ordenador que corre SAS es una rareza digna de fotografiarse.)</p>
<p>En R tenemos varias alternativas. Tal vez la más simple sea</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#a6e22e">library</span>( bootstrap )
<span style="color:#a6e22e">library</span>( moments )

N <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">10000</span>
x <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">runif</span>( N )
results <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">jackknife</span>( x, kurtosis )
<span style="color:#a6e22e">hist</span>( results<span style="color:#f92672">$</span>jack.values )</code></pre></td></tr></table>
</div>
</div>
<p>que utiliza la función jackknife del paquete <code>bootstrap</code> y tarda 13.12 segundos. Y con 50k muestras, unos 10 minutos (hummm&hellip; falta de linealidad). Pero merece la pena probar en este tipo de contextos el paralelismo en R.</p>
<p>Para ello, utilizaremos el paquete <code>doSMP</code>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#a6e22e">library</span>(doSMP)
w <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">startWorkers</span>(workerCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
<span style="color:#a6e22e">registerDoSMP</span>(w)</code></pre></td></tr></table>
</div>
</div>
<p>La primera línea carga el paquete. Las otras dos <em>registran</em> los <em>workers</em> dicho de otra manera, especifican cuántos hilos abrirá R para ejecutar las tareas que se paralelicen y los activan. Obviamente, no tiene sentido asignar más hilos que CPUs tenga el sistema.</p>
<p>Para ejecutar las tareas se utiliza foreach. Esta función es, en cierto modo, similar a for. Puede <em>cualificarse</em> con %dopar% o con %do%: la primera opción ejecuta el código en paralelo; la segunda, secuencialmente.</p>
<p>El código (con las dos opciones) es:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#75715e"># en paralelo</span>
res <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">foreach</span>( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>N, packages <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;moments&#34;</span> ) <span style="color:#f92672">%dopar%</span>
    <span style="color:#a6e22e">kurtosis</span>( x[<span style="color:#f92672">-</span>i] )

<span style="color:#75715e"># iterativo</span>
res <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">foreach</span>( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>N, packages <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;moments&#34;</span> ) <span style="color:#f92672">%do%</span>
    <span style="color:#a6e22e">kurtosis</span>( x[<span style="color:#f92672">-</span>i] )</code></pre></td></tr></table>
</div>
</div>
<p>Es necesario pasarle a <code>foreach</code> el nombre de los paquetes necesarios para ejecutar el código subsiguiente: si ejecutamos las líneas anteriores omitiendo el parámetro <code>.packages</code>, R se quejará por no poder encontrar la función <code>kurtosis</code>.</p>
<p>Los resultados no han resultado particularmente satisfactorios. Con la segunda opción, la secuencial, ha tardado 23 segundos. Con la primera, en paralelo, 14.58. Parece que el uso de <code>foreach</code> implica una sobrecarga computacional sustancial que consume los beneficios de la paralelización.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/jackknife/" rel="tag">jackknife</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/paralelizaci%C3%B3n/" rel="tag">paralelización</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/r/" rel="tag">r</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/sas/" rel="tag">sas</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/2011/09/29/predicciones-a-toro-pasado-y-el-perro-que-no-ladro/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Anterior</span>
			<p class="pager__title">Predicciones a toro pasado y el perro que no ladró</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/2011/10/03/gestion-avanzada-de-memoria-en-r-tracemem/" rel="next">
			<span class="pager__subtitle">Siguiente&thinsp;»</span>
			<p class="pager__title">Gestión avanzada de memoria en R: tracemem</p>
		</a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-recent widget">
	<h4 class="widget__title">Más Recientes</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2021/12/09/mas-sobre-exceso-mortalidad-noviembre-2021/">Sobre el exceso de mortalidad en noviembre de 2021</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/09/mas-sobre-la-estimacion-de-probabilidades-de-eventos-que-no-se-repiten/">Más sobre la estimación de probabilidades de eventos que no se repiten</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/07/estadistica-vs-siquiatria-la-aparente-contradiccion-la-profunda-sintesis/">Estadística vs siquiatría: la aparente contradicción, la profunda síntesis</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/12/02/por-que-cabe-argumentar-que-estos-resultados-infraestiman-la-efectividad-de-las-vacunas-contra-el-covid/">¿Por qué cabe argumentar que estos resultados infraestiman la efectividad de las vacunas contra el covid?</a></li>
			<li class="widget__item"><a class="widget__link" href="/2021/11/25/un-episodio-relevante-para-estas-paginas-extraido-de-un-espia-perfecto/">Un episodio relevante para estas páginas extraído de &#34;Un espía perfecto&#34;</a></li>
		</ul>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2021 datanalytics.
      
		</div>
	</div>
</footer>

	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"], ["$latex", "$"],["\\(","\\)"]]} })
</script>

</body>
</html>